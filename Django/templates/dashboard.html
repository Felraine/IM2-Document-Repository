{% extends 'main.html' %}

{% block title %}Dashboard{% endblock %}

{% load static %}
{% block content %}
<link
      rel="stylesheet"
      type="text/css"
      href="{% static 'dashboard_app/dashboardStyles.css' %}"/>
<div class="container">
  <h1>Dashboard</h1>
</div>

<div id="dashboard">

<div class="events">
  <div class="eventHeader">
    <h2 class="upcomingEventsTitle">Upcoming Events</h2>
    {% if user_role == 1 %}
    <button class="addEventBtn" id="addEventBtn">+ Add Event</button>
    {% endif %}
  </div>
  <div class="eventListContainer">
    <!--event list-->
    {% for event in events %}      
    <div class="eventList">
      <h3>{{ event.title }}</h3>
      <p>{{ event.description }}</p> 
      <p><strong>Location:</strong> {{ event.location }}</p>
      <p style="color: red;">{{ event.dateTime }}</p>

      <!--delete event-->
      {% if user_role == 1 %}
      <form method="POST" action="{% url 'deleteEvent' event.id %}" onsubmit="return confirmDel(this);"> 
        {% csrf_token %}
        <button type="submit" class="deleteBtn">Delete</button>
      </form>

      <!--edit event-->
      <button class="editBtn" onclick="openEditForm(
      '{{ event.id }}',   
      '{{ event.title }}',
      '{{ event.description }}',
      '{{ event.location }}', 
      '{{ event.dateTime }}')"
      >Edit</button>
      {% endif %}
    </div>
    
    {% empty %}
    <p>No upcoming events.</p>
    {% endfor %}
  </div>

  <!--Upcoming Meetings Section-->
  <div class="eventHeader">
    <h2 class="upcomingEventsTitle">Upcoming Meetings</h2>
    {% if user_role == 1 %}
    <button class="addMeeting" id="addMeetBtn">+ Add Meeting</button> <!--add meeting button-->
    {% endif %}
  </div>

  <div class="meetingListContainer">
    <!--event list-->
    {% for event in events %}      
    <div class="eventList">
      <h3>{{ event.title }}</h3>
      <p>{{ event.description }}</p> 
      <p><strong>Location:</strong> {{ event.location }}</p>
      <p style="color: red;">{{ event.dateTime }}</p>

      {% if user_role == 1 %}
      <!--delete event-->
      <form method="POST" action="{% url 'deleteEvent' event.id %}" onsubmit="return confirmDel(this);"> 
        {% csrf_token %}
        <button type="submit" class="deleteBtn">Delete</button>
      </form>

      <!--edit event-->
      <button class="editBtn" onclick="openEditForm(
      '{{ event.id }}',   
      '{{ event.title }}',
      '{{ event.description }}',
      '{{ event.location }}', 
      '{{ event.dateTime }}')"
      >Edit</button>
      {% endif %}
    </div>
    
    {% empty %}
    <p>No upcoming events.</p>
    {% endfor %}
  </div>

</div>

<div class="right-side">
  <div class="calendarContainer">
    <h2 class="calendarTitle">Calendar</h2>
    <div id="calendar"></div>
  </div>
  <!--TASK SECTION-->
  <div class="tasksContainer">
    <div class="tasksHeader">
      <h2 class="tasksTitle">Tasks</h2>
      <button class="assignTaskBtn">+ Assign Task</button>
    </div>
  <div class="tasksList">
    {% for task in tasks %}
    <div class="taskBox">
      <h3 class="taskTitle">{{ task.taskTitle }}</h3>
      <p class="taskDescription">{{task.taskDescription}}.</p>
    </div>
    {% endfor %}
  </div>
</div>

<!--FORM CONTAINER-->
<div id="toast" class="toast"></div>
<div class="overlay" id="overlay"></div>
<div class="eventFormContainer" id="eventFormContainer">
<span class="closeBtn" onclick="closeForm()">&times;</span>

<h2 class="title" id="formTitle">Add New Event</h2>
<form class="eventForm" id="eventForm" method="post" action="{% url 'addEvents' %}">
  {% csrf_token %}
  <input type="hidden" id="edit_event_id" name="event_id">
  <label for="title">Title:</label>
  <input type="text" id="title" name="title" required>
  <br><br>
  <label for="description">Description:</label>
  <textarea id="description" name="description" required></textarea>
  <br><br>
  <label for="location">Location:</label>
  <input type="text" id="location" name="location" required>
  <br><br>
  <label for="date_time">Date & Time:</label>
  <input type="datetime-local" id="date_time" name="date_time" required>
  <br><br>
  <button class="saveEventBtn" type="submit" id="saveEventBtn">Save Event</button>
</form>
  </div>
</div>
<!--HTML MODAL POP UP FOR DELETE-->
<div id="deleteConfirmationModal" class="modal">
  <div class="modalContent">
      <p>Are you sure you want to delete this event?</p>
      <div class="modalActions">
          <button id="confirmDeleteBtn" class="confirmBtn">DELETE</button>
          <button id="cancelDeleteBtn" class="cancelBtn">Cancel</button>
      </div>
  </div>
</div>
  {% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
  
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        timeZone: 'Asia/Manila',
        fixedWeekCount: false,
        showNonCurrentDates: true,
        events: '/dashboard/get_events/', 
        eventTimeFormat: { 
            hour: 'numeric',
            minute: '2-digit',
            meridiem: 'short'
        },
        eventContent: function(arg) {
            // Create the event time element
            const timeEl = document.createElement('div');
            timeEl.classList.add('fc-event-time');
            timeEl.textContent = arg.timeText; // Display event time only

            // Create the circle element
            const circleEl = document.createElement('div');
            circleEl.classList.add('fc-event-circle');
            circleEl.style.width = '10px';
            circleEl.style.height = '10px';
            circleEl.style.borderRadius = '50%';
            circleEl.style.marginRight = '5px';
            circleEl.style.backgroundColor = arg.event.extendedProps.color || '#fed534'; // Use event color or default to black

            // Wrap them together
            const wrapperEl = document.createElement('div');
            wrapperEl.style.display = 'flex';
            wrapperEl.style.alignItems = 'center';
            wrapperEl.appendChild(circleEl); // Add the circle
            wrapperEl.appendChild(timeEl);  // Add the time

            return { domNodes: [wrapperEl] };
        },
        windowResize: function(view) {
            calendar.render();
        }
    });
    calendar.render();

});




  let edit = false; // if edit btn pressed or nah
  let deleteForm = null; //modal form
  
  // confirm
  function confirmDel(form) {
      deleteForm = form;
      const modal = document.getElementById('deleteConfirmationModal');
      modal.style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
      return false;
  }

  document.getElementById('confirmDeleteBtn').onclick = function() {
  if (deleteForm) {
      deleteForm.submit(); 
  }
  hideModal(); 
};

  function hideModal() {
  const modal = document.getElementById('deleteConfirmationModal');
  modal.style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  }

document.getElementById('cancelDeleteBtn').onclick = hideModal;
document.getElementById('overlay').onclick = hideModal;
  
//UPDATING FORMS SECTION

  // edit event form
function openEditForm(id, title, description, location, dateTime) {
    document.getElementById('edit_event_id').value = id;
    document.getElementById('title').value = title;
    document.getElementById('description').value = description;
    document.getElementById('location').value = location;
    document.getElementById('date_time').value = dateTime;

    // Change the form title and action URL
    document.getElementById('formTitle').innerText = "Edit Event";
    document.getElementById('eventForm').action = "{% url 'updateEvent' %}"; 

    edit = true;

    document.getElementById('eventFormContainer').style.display = "block";
   
}

function showToast(message, isSuccess = true) {
  const toast = document.getElementById("toast");
  toast.textContent = message; 
  toast.className = `toast show ${isSuccess ? '' : 'error'}`; 
  setTimeout(() => {
      toast.className = "toast"; 
  }, 3000);
}

const saveEventBtn = document.getElementById('saveEventBtn');
saveEventBtn.onclick = function(){
  if (edit && document.getElementById('date_time').value) {
        showToast("Event details changed successfully!");
    } else {
        showToast("Please fill out the entire form.",false);
    }

}

// Open add event form
const addEventBtn = document.getElementById('addEventBtn');
addEventBtn.onclick = function() {
    edit = false;
    document.getElementById('formTitle').innerText = "Add New Event";
    document.getElementById('eventForm').action = "{% url 'addEvents' %}";
    document.getElementById('eventForm').reset(); 
    document.getElementById('eventFormContainer').style.display = "block";
    document.getElementById('overlay').style.display = "block";

}

// Close form
function closeForm() {
    document.getElementById('eventFormContainer').style.display = "none";
    document.getElementById('overlay').style.display = "none";
    document.getElementById('overlay').onclick = hideModal;
  
}

document.getElementById('overlay').onclick = function() {
    closeForm();
}
</script>
{% endblock %}
