{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="author" content="Felraine Cataos" />
    <meta name="Dashboard" content="Dashboard Screen" />

    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'dashboard_app/dashboardStyles.css' %}"
    />

    <title>Dashboard</title>
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{% static 'images/CIT_logo.png' %}"
    />
    <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css"
    rel="stylesheet"
  />
  </head>
  <body>
    <div class="sidebar">
      <div class="top">
        <div class="logo">
          <img
            src="{% static 'images/CIT_logo.png' %}"
            alt="logo"
            class="logo"
          />
          <span class="orgName">CSS</span>
        </div>
        <i class="bx bx-menu" id="btn"></i>
        <div class="user">
          <img
            src="{% static 'images/profile.jpg' %}"
            alt="user"
            class="user"
          />
          <div class="name">
            <p class="username">{{ fname }} {{ lname }}</p>
            <p class="role">
              {% if user_role == 0 %} Member {% else %} {% if user_role == 1 %}
              Admin {% else %} Unknown Role {% endif %} {% endif %}
            </p>
          </div>
        </div>
        <ul>
          <li>
            <a href="{% url 'dashboard' %}">
              <img
                src="{% static 'images/home.png' %}"
                alt="home"
                class="icon home-icon"
              />
              <span class="nav-item">Dashboard</span>
            </a>
            <span class="tooltip">Dashboard</span>
          </li>
          <li>
            <a href="{% url 'calendar' %}">
              <img
                src="{% static 'images/calendar.png' %}"
                alt="calendar"
                class="icon calendar-icon"
              />
              <span class="nav-item">Calendar</span>
            </a>
            <span class="tooltip">Calendar</span>
          </li>
          <li>
            <a href="{% url 'members' %}">
              <img
                src="{% static 'images/group.png' %}"
                alt="Members List"
                class="icon member-icon"
              />
              <span class="nav-item">Members</span>
            </a>
            <span class="tooltip">Members</span>
          </li>
          <li>
            <a href="{% url 'register' %}">
              <img
                src="{% static 'images/logout.png' %}"
                alt="logout"
                class="icon logout-icon"
              />
              <span class="nav-item">Logout</span>
            </a>
            <span class="tooltip">Logout</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Start adding code here for UI-->
<div class="main-content">
  <div class="container">
    <h1>Dashboard</h1>
  </div>
  
  <div id="dashboard">

  <div class="events">
    <div class="eventHeader">
      <h2 class="upcomingEventsTitle">Upcoming Events</h2>
      <button class="addEventBtn" id="addEventBtn">+ Add Event</button>
    </div>
    <div class="eventListContainer">
      <!--event list-->
      {% for event in events %}      
      <div class="eventList">
        <h3>{{ event.title }}</h3>
        <p>{{ event.description }}</p> 
        <p><strong>Location:</strong> {{ event.location }}</p>
        <p style="color: red;">{{ event.dateTime }}</p>

        <!--delete event-->
        <form method="POST" action="{% url 'deleteEvent' event.id %}" onsubmit="return confirmDel(this);"> 
          {% csrf_token %}
          <button type="submit" class="deleteBtn">Delete</button>
        </form>

        <!--edit event-->
        <button class="editBtn" onclick="openEditForm(
        '{{ event.id }}',   
        '{{ event.title }}',
        '{{ event.description }}',
        '{{ event.location }}', 
        '{{ event.dateTime }}')"
        >Edit</button>
      </div>
      
      {% empty %}
      <p>No upcoming events.</p>
      {% endfor %}
    </div>

    <!--Upcoming Meetings Section-->
    <div class="eventHeader">
      <h2 class="upcomingEventsTitle">Upcoming Meetings</h2>
      <button class="addEventBtn" id="addEventBtn">+ Add Meeting</button> <!--add meeting button-->
    </div>

    <div class="eventListContainer">
      <!--event list-->
      {% for event in events %}      
      <div class="eventList">
        <h3>{{ event.title }}</h3>
        <p>{{ event.description }}</p> 
        <p><strong>Location:</strong> {{ event.location }}</p>
        <p style="color: red;">{{ event.dateTime }}</p>

        <!--delete event-->
        <form method="POST" action="{% url 'deleteEvent' event.id %}" onsubmit="return confirmDel(this);"> 
          {% csrf_token %}
          <button type="submit" class="deleteBtn">Delete</button>
        </form>

        <!--edit event-->
        <button class="editBtn" onclick="openEditForm(
        '{{ event.id }}',   
        '{{ event.title }}',
        '{{ event.description }}',
        '{{ event.location }}', 
        '{{ event.dateTime }}')"
        >Edit</button>
      </div>
      
      {% empty %}
      <p>No upcoming events.</p>
      {% endfor %}
    </div>

  </div>

  <div class="right-side">
    <div class="calendarContainer">
      <h2 class="calendarTitle">Calendar</h2>
      <div id="calendar"></div>
    </div>

    <div class="tasksContainer">
      <h2 class="tasksTitle">Tasks</h2>
      <ul class="tasksList">
        {% for task in tasks %}
          <li class="taskItem">{{ task.title }}</li>
        {% empty %}
          <li class="taskItem">No tasks available.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
</div> <!--div for class events-->

<!--FORM CONTAINER-->
<div id="toast" class="toast"></div>
<div class="overlay" id="overlay"></div>
<div class="eventFormContainer" id="eventFormContainer">
  <span class="closeBtn" onclick="closeForm()">&times;</span>

  <h2 class="title" id="formTitle">Add New Event</h2>
  <form class="eventForm" id="eventForm" method="post" action="{% url 'addEvents' %}">
    {% csrf_token %}
    <input type="hidden" id="edit_event_id" name="event_id">
    <label for="title">Title:</label>
    <input type="text" id="title" name="title" required>
    <br><br>
    <label for="description">Description:</label>
    <textarea id="description" name="description" required></textarea>
    <br><br>
    <label for="location">Location:</label>
    <input type="text" id="location" name="location" required>
    <br><br>
    <label for="date_time">Date & Time:</label>
    <input type="datetime-local" id="date_time" name="date_time" required>
    <br><br>
    <button class="saveEventBtn" type="submit" id="saveEventBtn">Save Event</button>
  </form>
    </div>
  </div>
  <!--HTML MODAL POP UP FOR DELETE-->
  <div id="deleteConfirmationModal" class="modal">
    <div class="modalContent">
        <p>Are you sure you want to delete this event?</p>
        <div class="modalActions">
            <button id="confirmDeleteBtn" class="confirmBtn">DELETE</button>
            <button id="cancelDeleteBtn" class="cancelBtn">Cancel</button>
        </div>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
  <script>

document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        fixedWeekCount: false, 
        showNonCurrentDates: true, 
        events: [
            {% for event in events %}
                {
                    title: '{{ event.title }}',
                    start: '{{ event.dateTime }}',
                    description: '{{ event.description }}',
                    location: '{{ event.location }}'
                }
                {% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        windowResize: function(view) {
            calendar.render();
        },
        datesRender: function(info) {
            // Select the calendar's month view element
            var gridEl = info.view.el.querySelector('.fc-dayGridMonth-view');
            
            // Get all the rows in the month view
            var rows = gridEl.querySelectorAll('.fc-dayGridWeek');
            
            // Ensure only 5 rows are visible
            if (rows.length > 5) {
                // Hide extra rows beyond the 5th one
                for (var i = 5; i < rows.length; i++) {
                    rows[i].style.display = 'none';
                }
            }
        }
    });
    calendar.render();
});



    let edit = false; // if edit btn pressed or nah
    let deleteForm = null; //modal form
    
    // confirm
    function confirmDel(form) {
        deleteForm = form;
        const modal = document.getElementById('deleteConfirmationModal');
        modal.style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        return false;
    }

    document.getElementById('confirmDeleteBtn').onclick = function() {
    if (deleteForm) {
        deleteForm.submit(); 
    }
    hideModal(); 
};

    function hideModal() {
    const modal = document.getElementById('deleteConfirmationModal');
    modal.style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    }

  document.getElementById('cancelDeleteBtn').onclick = hideModal;
  document.getElementById('overlay').onclick = hideModal;
    
  //UPDATING FORMS SECTION

    // edit event form
  function openEditForm(id, title, description, location, dateTime) {
      document.getElementById('edit_event_id').value = id;
      document.getElementById('title').value = title;
      document.getElementById('description').value = description;
      document.getElementById('location').value = location;
      document.getElementById('date_time').value = dateTime;

      // Change the form title and action URL
      document.getElementById('formTitle').innerText = "Edit Event";
      document.getElementById('eventForm').action = "{% url 'updateEvent' %}"; 

      edit = true;

      document.getElementById('eventFormContainer').style.display = "block";
     
  }

  function showToast(message, isSuccess = true) {
    const toast = document.getElementById("toast");
    toast.textContent = message; 
    toast.className = `toast show ${isSuccess ? '' : 'error'}`; 
    setTimeout(() => {
        toast.className = "toast"; 
    }, 3000);
}

  const saveEventBtn = document.getElementById('saveEventBtn');
  saveEventBtn.onclick = function(){
    if (edit && document.getElementById('date_time').value) {
          showToast("Event details changed successfully!");
      } else {
          showToast("Please fill out the entire form.",false);
      }

  }

  // Open add event form
  const addEventBtn = document.getElementById('addEventBtn');
  addEventBtn.onclick = function() {
      edit = false;
      document.getElementById('formTitle').innerText = "Add New Event";
      document.getElementById('eventForm').action = "{% url 'addEvents' %}";
      document.getElementById('eventForm').reset(); 
      document.getElementById('eventFormContainer').style.display = "block";
      document.getElementById('overlay').style.display = "block";

  }

  // Close form
  function closeForm() {
      document.getElementById('eventFormContainer').style.display = "none";
      document.getElementById('overlay').style.display = "none";
      document.getElementById('overlay').onclick = hideModal;
    
  }

  document.getElementById('overlay').onclick = function() {
      closeForm();
  }
  </script>

    <script>
      let btn = document.querySelector("#btn");
      let sidebar = document.querySelector(".sidebar");

      btn.onclick = function () {
        sidebar.classList.toggle("active");
      };

      const listItems = document.querySelectorAll("li");
      listItems.forEach((listItem) => {
        listItem.addEventListener("mouseover", function () {
          const homeIcon = this.querySelector(".home-icon");
          const calendarIcon = this.querySelector(".calendar-icon");
          const memberIcon = this.querySelector(".member-icon");
          const settingsIcon = this.querySelector(".settings-icon");
          const logoutIcon = this.querySelector(".logout-icon");

          if (homeIcon) {
            homeIcon.src = "{% static 'images/home2.png' %}";
          }
          if (calendarIcon) {
            calendarIcon.src = "{% static 'images/calendar2.png' %}";
          }
          if (memberIcon) {
            memberIcon.src = "{% static 'images/group2.png' %}";
          }
          if (settingsIcon) {
            settingsIcon.src = "{% static 'images/settings2.png' %}";
          }
          if (logoutIcon) {
            logoutIcon.src = "{% static 'images/logout2.png' %}";
          }
        });

        listItem.addEventListener("mouseout", function () {
          const homeIcon = this.querySelector(".home-icon");
          const calendarIcon = this.querySelector(".calendar-icon");
          const memberIcon = this.querySelector(".member-icon");
          const settingsIcon = this.querySelector(".settings-icon");
          const logoutIcon = this.querySelector(".logout-icon");

          if (homeIcon) {
            homeIcon.src = "{% static 'images/home.png' %}";
          }
          if (calendarIcon) {
            calendarIcon.src = "{% static 'images/calendar.png' %}";
          }
          if (memberIcon) {
            memberIcon.src = "{% static 'images/group.png' %}";
          }
          if (settingsIcon) {
            settingsIcon.src = "{% static 'images/settings.png' %}";
          }
          if (logoutIcon) {
            logoutIcon.src = "{% static 'images/logout.png' %}";
          }
        });
      });
    </script>
  </body>
</html>
